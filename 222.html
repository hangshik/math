<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>연립방정식</title>
  <script>
    window.MathJax = {
      tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] }
    };
  </script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
  <style>
    body { font-family: sans-serif; }
    .stage-button {
      font-size: 20px; margin: 5px; padding: 10px 20px;
      border: none; border-radius: 10px; cursor: pointer;
    }
    .active {
      background-color: #3399FF; color: white;
    }
    .input-box {
      width: 80px; height: 40px; font-size: 30px; text-align: center;
      margin: 0 10px; border: 2px solid #333; border-radius: 5px;
    }
    .selected { background-color: #3399FF; color: white; }
    .button {
      width: 60px; height: 60px; font-size: 25px; margin: 2px 0;
      border-radius: 10px; border: none; background-color: #DDDDDD; cursor: pointer;
    }
    .button:hover { background-color: #bbb; }
    #result1 { min-height: 45px; }
    #nextBtn:disabled {
      background-color: #aaa !important;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <center>
    <h1>연립방정식</h1>
    <div>
      <button id="btn1" class="stage-button" onclick="setStage(1)">1단계</button>
      <button id="btn2" class="stage-button" onclick="setStage(2)">2단계</button>
      <button id="btn3" class="stage-button" onclick="setStage(3)">3단계</button>
      <button id="btn4" class="stage-button" onclick="setStage(4)">4단계</button>
    </div>

    <div id="problem" style="font-size: 30px; margin-top: 20px;">문제</div>

    <div style="margin-top: 20px; display: flex; justify-content: center; align-items: center;">
      <span style="font-size: 30px;">$x$ =</span>
      <input type="text" id="inputX" class="input-box selected" readonly onclick="selectInput('x')">
      <span style="font-size: 30px; margin-left: 20px;">$y$ =</span>
      <input type="text" id="inputY" class="input-box" readonly onclick="selectInput('y')">
    </div>

    <br>

    <div>
      <button class="button" onclick="appendNumber(1)">1</button>
      <button class="button" onclick="appendNumber(2)">2</button>
      <button class="button" onclick="appendNumber(3)">3</button>
      <button class="button" onclick="appendNumber(4)">4</button>
      <button class="button" onclick="appendNumber(5)">5</button><br>
      <button class="button" onclick="appendNumber(6)">6</button>
      <button class="button" onclick="appendNumber(7)">7</button>
      <button class="button" onclick="appendNumber(8)">8</button>
      <button class="button" onclick="appendNumber(9)">9</button>
      <button class="button" onclick="appendNumber(0)">0</button><br>
      <button class="button" onclick="appendNumber('-')">-</button>
      <button class="button" onclick="appendNumber('/')">/</button>
      <button class="button" onclick="clearInput()">C</button>
      <button class="button" onclick="backspace()">←</button>
      <button class="button" onclick="checkAnswer()" style="background-color: #3399FF; color: white;">확인</button><br><br>
      <button id="nextBtn" class="button" onclick="generateProblem()" style="background-color: #3399FF; color: white; width: 320px;" disabled>다음 문제(Space)</button>
    </div>

    <hr/>
    <div id="result1" style="font-size:30px;">정답여부</div>
    <div id="result2" style="font-size:30px;">0번 정답입니다.</div>
    <div id="result3" style="font-size:30px;">0번 틀렸습니다.</div>

    <!-- 정답확인용 1/3 -->
    <!-- <div id="answer" style="font-size:28px; margin-top:20px; color:#888;">
      (정답: x = <span id="showX"></span>, y = <span id="showY"></span>)
    </div> -->
    <br><br><br>
    <div style="font-size: 25px;">
      1, 2단계: 정답이 정수<br>
      3단계: 정답이 분수<br>
      4단계: 정답이 정수 또는 분수<br>
    </div>
  </center>

  <script>
    document.addEventListener('contextmenu', e => e.preventDefault());

    let currentStage = 1;
    let selectedInput = 'x';
    let solutionX = 0;
    let solutionY = 0;
    let winCount = 0;
    let loseCount = 0;

    function gcd(a,b) {
      while (b) [a,b] = [b,a%b];
      return Math.abs(a);
    }
    function gcd3(a,b,c) { return gcd(gcd(a,b),c); }
    function lcm(a,b) { return Math.abs(a*b) / gcd(a,b); }

    function setStage(stage) {
      currentStage = stage;
      for (let i = 1; i <= 4; i++) {
        document.getElementById("btn" + i).classList.toggle("active", i === stage);
      }
      generateProblem();
    }

    function selectInput(target) {
  selectedInput = target;
  document.getElementById('inputX').classList.remove('selected');
  document.getElementById('inputY').classList.remove('selected');
  document.getElementById('result1').textContent = "";
  document.getElementById('result1').style.backgroundColor = "white";
  document.getElementById('result1').style.color = "black";
  if (target === 'x') {
    document.getElementById('inputX').classList.add('selected');
    document.getElementById('inputX').value = "";
  } else {
    document.getElementById('inputY').classList.add('selected');
    document.getElementById('inputY').value = "";
  }
}


function appendNumber(num) {
  const input = selectedInput === 'x' ? document.getElementById('inputX') : document.getElementById('inputY');
  input.value += num;

  // 정답여부 메시지 초기화 + 배경색, 글자색 초기화
  const res = document.getElementById('result1');
  res.textContent = "";
  res.style.backgroundColor = "white";
  res.style.color = "black";
}

function backspace() {
  const input = selectedInput === 'x' ? document.getElementById('inputX') : document.getElementById('inputY');
  input.value = input.value.slice(0, -1);

  // 정답여부 메시지 초기화 + 배경색, 글자색 초기화
  const res = document.getElementById('result1');
  res.textContent = "";
  res.style.backgroundColor = "white";
  res.style.color = "black";
}

function clearInput() {
  const input = selectedInput === 'x' ? document.getElementById('inputX') : document.getElementById('inputY');
  input.value = "";

  // 정답여부 메시지 초기화 + 배경색, 글자색 초기화
  const res = document.getElementById('result1');
  res.textContent = "";
  res.style.backgroundColor = "white";
  res.style.color = "black";
}


    // a,b,d,e는 0이 나오면 다시 뽑기,  c,f도 -20~20 범위만 허용
function getNonZeroCoeff() {
  let val;
  do {
    val = getNonOneCoeff();
  } while(val === 0);
  return val;
}

function generateProblem() {
  document.getElementById('nextBtn').disabled = true;

  let a,b,c,d,e,f;
  while (true) {
    if (currentStage <= 2) {
      solutionX = (Math.random() < 0.5 ? 1 : -1) * (Math.floor(Math.random() * 9) + 1);
      solutionY = (Math.random() < 0.5 ? 1 : -1) * (Math.floor(Math.random() * 9) + 1);
    } else {
      const fractions = [ [1,2],[1,3],[2,3],[1,4],[3,4],[1,5],[2,5],[3,5],[4,5],[1,6],[5,6] ];
      let fracX = fractions[Math.floor(Math.random() * fractions.length)];
      let fracY = fractions[Math.floor(Math.random() * fractions.length)];
      solutionX = [ (Math.random() < 0.5 ? 1 : -1) * fracX[0], fracX[1] ];
      solutionY = [ (Math.random() < 0.5 ? 1 : -1) * fracY[0], fracY[1] ];
    }

    a = getNonZeroCoeff();
    b = getNonZeroCoeff();
    d = getNonZeroCoeff();
    e = getNonZeroCoeff();

    if (currentStage === 1) {
      if (Math.random() < 0.5) d = Math.sign(a) * Math.abs(a);
      else e = Math.sign(b) * Math.abs(b);
    }

    if (a*e === b*d) continue;

    if (currentStage <= 2) {
      c = a * solutionX + b * solutionY;
      f = d * solutionX + e * solutionY;
    } else {
      let lcmXY = lcm(solutionX[1], solutionY[1]);
      let xInt = solutionX[0] * (lcmXY/solutionX[1]);
      let yInt = solutionY[0] * (lcmXY/solutionY[1]);

      c = a * xInt + b * yInt;
      f = d * xInt + e * yInt;

      a *= lcmXY; b *= lcmXY; d *= lcmXY; e *= lcmXY;
    }

    // 0 제외, -20~20 범위 체크
    if ([a,b,c,d,e,f].some(v => v === 0 || v < -20 || v > 20)) continue;

    if (gcd3(a,b,c) !== 1) continue;
    if (gcd3(d,e,f) !== 1) continue;

    // 정답확인용 2/3
    // showAnswer();
    break;
  }

  const showA = (a === 1) ? '' : (a === -1) ? '-' : a;
  const showB = (b === 1) ? '+': (b === -1) ? '-' : (b > 0 ? `+${b}` : b);
  const showD = (d === 1) ? '' : (d === -1) ? '-' : d;
  const showE = (e === 1) ? '+' : (e === -1) ? '-' : (e > 0 ? `+${e}` : e);

  const latex = `
    \\[
    \\left\\{
    \\begin{array}{l}
    ${showA}x ${showB}y = ${c} \\\\
    ${showD}x ${showE}y = ${f}
    \\end{array}
    \\right.
    \\]
  `;
  document.getElementById("problem").innerHTML = latex;
  MathJax.typesetPromise();

  document.getElementById("inputX").value = "";
  document.getElementById("inputY").value = "";
  selectInput('x');
  document.getElementById('result1').textContent = "";
}


    function getNonOneCoeff() {
      if (Math.random() < 0.05) {
        return Math.random() < 0.5 ? 1 : -1;
      } else {
        let n = Math.floor(Math.random() * 8) + 2;
        return Math.random() < 0.5 ? n : -n;
      }
    }

    function evalFraction(value) {
      if (value.includes('/')) {
        const [num, den] = value.split('/');
        return parseFloat(num)/parseFloat(den);
      } else return parseFloat(value);
    }

    function checkAnswer() {
      const x = evalFraction(document.getElementById('inputX').value.trim());
      const y = evalFraction(document.getElementById('inputY').value.trim());

      let trueX, trueY;
      if (Array.isArray(solutionX)) {
        trueX = solutionX[0]/solutionX[1];
        trueY = solutionY[0]/solutionY[1];
      } else {
        trueX = solutionX;
        trueY = solutionY;
      }

      const eps = 1e-6;
      const xCorrect = Math.abs(x-trueX)<eps;
      const yCorrect = Math.abs(y-trueY)<eps;

      if (xCorrect && yCorrect) {
        document.getElementById('result1').innerHTML = `정답입니다!`;
        document.getElementById("result1").style.backgroundColor = "green";
        document.getElementById("result1").style.color = "white";
        winCount++;
        document.getElementById('result2').textContent = `${winCount}번 정답입니다.`;
        document.getElementById('nextBtn').disabled = false;
      } else {
        let msg = "";
        if (!xCorrect && !yCorrect) msg = "x, y 값이 모두 틀렸습니다!";
        else if (!xCorrect) msg = "x 값이 틀렸습니다!";
        else msg = "y 값이 틀렸습니다!";

        document.getElementById('result1').textContent = msg;
        document.getElementById("result1").style.backgroundColor = "red";
        document.getElementById("result1").style.color = "white";
        loseCount++;
        document.getElementById('result3').textContent = `${loseCount}번 틀렸습니다.`;
      }
    }

    document.addEventListener('keydown', e => {
      if (e.key >= '0' && e.key <= '9') appendNumber(e.key);
      else if (e.key === '-') appendNumber('-');
      else if (e.key === '/') appendNumber('/');
      else if (e.key === 'Backspace') backspace();
      else if (e.key === 'Escape') clearInput();
      else if (e.key === 'Enter') checkAnswer();
      else if (e.code === 'Space') {
        e.preventDefault();
        if (!document.getElementById('nextBtn').disabled) {
          generateProblem();
        }
      }
      else if (e.key === 'Tab') {
        e.preventDefault();
        if (selectedInput === 'x') selectInput('y');
        else selectInput('x');
      }
    });

    // 정답확인용 3/3
    // function showAnswer() {
    //   if (Array.isArray(solutionX)) {
    //     document.getElementById('showX').textContent = `${solutionX[0]}/${solutionX[1]}`;
    //     document.getElementById('showY').textContent = `${solutionY[0]}/${solutionY[1]}`;
    //   } else {
    //     document.getElementById('showX').textContent = solutionX;
    //     document.getElementById('showY').textContent = solutionY;
    //   }
    // }

    window.onload = ()=> setStage(1);
  </script>
</body>
</html>
