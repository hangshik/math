<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=0.8">
<title>이차방정식</title>
<script>
  window.MathJax = { tex: { inlineMath: [['$', '$'], ['\\(', '\\)']] } };
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js" async></script>
<style>
  body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f2f5; }
  .container { max-width: 800px; margin: auto; background: white; padding: 30px; border-radius: 20px; box-shadow: 0 8px 20px rgba(0,0,0,0.1); }
  .question { font-size: 34px; margin: 30px 0; font-weight: bold; color: #333; }
  .choices { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
  .choices button { height: 80px; font-size: 20px; border-radius: 12px; border: 2px solid #e0e0e0; background: #fff; cursor: pointer; transition: 0.3s; }
  .choices button:hover { border-color: #3399FF; background: #f0f7ff; }
  .choices button.correct { background: #4CAF50 !important; color: white; border-color: #4CAF50; }
  .choices button.wrong { background: #f44336 !important; color: white; border-color: #f44336; }
  #resultBox { font-size: 24px; margin: 15px 0; padding: 15px; border-radius: 10px; background: #eee; }
  .stage-btn { padding: 10px 20px; margin: 5px; border-radius: 8px; border: none; background: #ddd; cursor: pointer; font-weight: bold; }
  .stage-btn.active { background: #3399FF; color: white; }
</style>
</head>
<body>
<div class="container">
  <h1>이차방정식</h1>
  <div id="stageButtons">
    <button class="stage-btn active" onclick="setStage(1)">1단계</button>
    <button class="stage-btn" onclick="setStage(2)">2단계</button>
    <button class="stage-btn" onclick="setStage(3)">3단계</button>
    <button class="stage-btn" onclick="setStage(4)">4단계</button>
    <button class="stage-btn" onclick="setStage(5)">5단계</button>
    <button class="stage-btn" onclick="setStage(6)">6단계</button>
  </div>

  <div class="question" id="questionBox"></div>
  <div class="choices" id="choicesBox"></div>
  <div id="resultBox">문제를 풀어보세요!</div>
  <div id="scoreBoard">정답: 0 | 오답: 0</div>
  <br>
  <button onclick="generateQuiz()" style="width:200px; height:50px; border-radius:10px; border:none; background:#333; color:white; cursor:pointer;">문제 건너뛰기</button>
</div>

<script>
let currentStage = 1, correctTotal = 0, wrongTotal = 0, solved = false, currentAns = "";

function gcd(a, b) { return b ? gcd(b, a % b) : Math.abs(a); }

// 루트 단순화 (sqrt(28) -> 2root7)
function simplifySqrt(n) {
    let out = 1, inside = n;
    for (let i = 2; i * i <= inside; i++) {
        while (inside % (i * i) === 0) {
            out *= i;
            inside /= (i * i);
        }
    }
    return [out, inside]; // out * sqrt(inside)
}

function formatFraction(num, den) {
    if (den < 0) { num = -num; den = -den; }
    let common = gcd(num, den);
    num /= common; den /= common;
    return den === 1 ? `${num}` : `\\frac{${num}}{${den}}`;
}

function solveEquation(a, b, c) {
    let d = b * b - 4 * a * c;
    if (d < 0) return "실근 없음";
    let sqrtD = Math.sqrt(d);

    if (Number.isInteger(sqrtD)) {
        let x1_num = -b + sqrtD, x2_num = -b - sqrtD, den = 2 * a;
        let res1 = formatFraction(x1_num, den), res2 = formatFraction(x2_num, den);
        return res1 === res2 ? res1 : (x1_num < x2_num ? `${res1}, ${res2}` : `${res2}, ${res1}`);
    } else {
        let [out, inside] = simplifySqrt(d);
        let realB = -b, den = 2 * a;
        let common = gcd(realB, gcd(out, den));
        realB /= common; out /= common; den /= common;

        let bPart = realB === 0 ? "" : `${realB}`;
        let rPart = out === 1 ? `\\sqrt{${inside}}` : `${out}\\sqrt{${inside}}`;
        let combined = bPart === "" ? `\\pm ${rPart}` : `${realB} \\pm ${rPart}`;
        
        return den === 1 ? combined : `\\frac{${combined}}{${den}}`;
    }
}

function setStage(s) {
    currentStage = s;
    document.querySelectorAll('.stage-btn').forEach((b, i) => b.classList.toggle('active', i + 1 === s));
    generateQuiz();
}

function generateQuiz() {
    solved = false;
    document.getElementById("resultBox").textContent = "정답여부";
    document.getElementById("resultBox").style.background = "#eee";

    let a = (currentStage <= 3) ? 1 : (Math.floor(Math.random() * 4) + 2);
    let b, c;

    // 1, 4단계: 정수/유리수근
    if (currentStage === 1 || currentStage === 4) {
        let r1 = Math.floor(Math.random() * 10) - 5;
        let r2 = Math.floor(Math.random() * 10) - 5;
        b = -a * (r1 + r2); c = a * r1 * r2;
    } 
    // 2, 5단계: 무리수근
    else if (currentStage === 2 || currentStage === 5) {
        while (true) {
            b = Math.floor(Math.random() * 10) - 5;
            c = Math.floor(Math.random() * 10) - 5;
            let d = b * b - 4 * a * c;
            if (d > 0 && !Number.isInteger(Math.sqrt(d))) break;
        }
    } 
    // 3, 6단계: 혼합
    else {
        b = Math.floor(Math.random() * 10) - 5;
        c = Math.floor(Math.random() * 10) - 5;
        if ((b*b - 4*a*c) < 0) return generateQuiz();
    }

    currentAns = solveEquation(a, b, c);
    
    // 문제 출력
    let aStr = a === 1 ? "x^2" : `${a}x^2`;
    let bStr = b === 0 ? "" : (b > 0 ? ` + ${b === 1 ? "" : b}x` : ` - ${Math.abs(b) === 1 ? "" : Math.abs(b)}x`);
    let cStr = c === 0 ? "" : (c > 0 ? ` + ${c}` : ` - ${Math.abs(c)}`);
    document.getElementById("questionBox").innerHTML = `$$ ${aStr}${bStr}${cStr} = 0 $$`;

    // 보기 생성
    let choices = [currentAns];
    while(choices.length < 4) {
        let fA = a, fB = b + (Math.floor(Math.random() * 6) - 3), fC = c + (Math.floor(Math.random() * 6) - 3);
        let fake = solveEquation(fA, fB, fC);
        
        // 단계별 보기 타입 강제
        if ((currentStage === 1 || currentStage === 4) && fake.includes("sqrt")) continue;
        if ((currentStage === 2 || currentStage === 5) && !fake.includes("sqrt")) continue;
        
        if (!choices.includes(fake) && fake !== "실근 없음") choices.push(fake);
    }
    choices.sort(() => Math.random() - 0.5);

    const box = document.getElementById("choicesBox");
    box.innerHTML = "";
    choices.forEach(txt => {
        const btn = document.createElement("button");
        btn.innerHTML = `$$ x = ${txt} $$`;
        btn.onclick = () => {
            if(solved) return;
            if(txt === currentAns) {
                solved = true; btn.classList.add("correct"); correctTotal++;
                document.getElementById("resultBox").textContent = "정답입니다!";
                document.getElementById("resultBox").style.background = "#4CAF50";
                setTimeout(generateQuiz, 1000);
            } else {
                btn.classList.add("wrong"); wrongTotal++;
                document.getElementById("resultBox").textContent = "틀렸습니다.";
                document.getElementById("resultBox").style.background = "#f44336";
            }
            document.getElementById("scoreBoard").textContent = `정답: ${correctTotal} | 오답: ${wrongTotal}`;
        };
        box.appendChild(btn);
    });
    MathJax.typesetPromise();
}

window.onload = generateQuiz;
</script>
</body>
</html>